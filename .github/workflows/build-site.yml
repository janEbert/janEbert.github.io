name: Build Site

on:
  push:
    branches:
      - master

jobs:
  build-site:
    runs-on: ubuntu-latest
    steps:
      - name: install-dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install git emacs elpa-org make

      - name: setup-repo
        uses: actions/checkout@v2

      - name: clone-build-repo
        run: git clone --single-branch --branch gh-pages --depth 1 https://github.com/${GITHUB_REPOSITORY}.git build

      - name: build
        run: make EMACS_FLAGS=''

      - name: configure-new-repo
        run: |
          cd build/
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "janpublicebert@posteo.net"

      - name: push-changes
        if: success()
        run: |
          cd build/
          git add .
          git commit -m "Build from ${GITHUB_SHA}"
          git push "https://${{ secrets.JAN_WEBSITE_PAT }}@github.com/${GITHUB_REPOSITORY}.git" gh-pages
